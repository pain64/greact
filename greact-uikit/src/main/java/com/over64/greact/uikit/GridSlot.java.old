package iias.web.plainjs.libgrid;

import com.greact.model.*;
import com.over64.greact.dom.HTMLNativeElements.*;
import com.over64.greact.dom.HtmlElement;
import iias.web.plainjs.libgrid.controls.Cascade;

import java.util.function.Function;

@CSS.Require({"grid.css"})
public class GridSlot<T> implements Component1<div, T[]> {
    public Object dependsOn;
    public Generated<T, ?>[] generated = (Generated<T, ?>[]) new Object[0];
    // create `column` method?
    public Column<T, ?>[] columns = (Column<T, ?>[]) new Object[0];
    public Component1<div, T> expandedRow;
    public Component1<div, T> selectedRow;
    public RowAdder<T> customRowAdder = null;

    @FunctionalInterface
    public interface AsyncHandler<T> {
        @async
        void handle(T value);
    }

    @FunctionalInterface
    public interface AsyncSupplier<T> {
        @async
        T supply(T value);
    }

    public AsyncSupplier<T> onRowAdd;
    public AsyncHandler<T> onRowChange;
    public AsyncHandler<T> onRowDelete;

    public <U> Column<T, U> adjust(MemberRef<T, U> ref) {
        for (var col : columns) {
            if (col.memberNames.length != ref.memberNames().length) continue;
            for (var i = 0; i < col.memberNames.length; i++) {
                if (col.memberNames[i] != ref.memberNames()[i]) continue;
                return (Column<T, U>) col;
            }
        }

        return null;
    }

//    public void hide() {
//
//    }

//    public Grid(T[] data) {
//        this.list = arrayMap(data, v -> new _00Row<>(v));
//        // FIXME: нужно разобраться с VarArgs
//        //this.columns = JSExpression.of("[].slice.call(arguments, 1)");
//    }

    <A> boolean strictEqual(A lhs, A rhs) { return JSExpression.of("lhs === rhs"); }

    <A, B> B[] arrayMap(A[] from, Function<A, B> mapper) {
        return JSExpression.of("from.map(mapper)");
    }

    <A> A[] arrayFilter(A[] from, Cascade.Func1<A, Boolean> predicate) {
        return JSExpression.of("from.filter(predicate)");
    }

    <A> void arrayPush(A[] array, A value) {
        JSExpression.of("array.push(value)");
    }

    <A, B> Pair<A, B>[] arrayZip(A[] left, B[] right) {
        Pair<A, B>[] result = (Pair<A, B>[]) new Object[0];
        for (var i = 0; i < left.length; i++)
            arrayPush(result, new Pair<>(left[i], right[i]));
        return result;
    }

    Object fetchValue(T rowData, String memberNames[]) {
        Object acc = rowData;
        for (var i = 0; i < memberNames.length; i++)
            acc = JSExpression.of("acc[memberNames[i]]");
        return acc;
    }

    Void updateCol(Column<T, ?> col, T rowData) {
        var _col = (Column<T, Object>) col;
        _col._editor.value = fetchValue(rowData, col.memberNames);
        return null;
    }

    String colViewAsString(Column<T, ?> col, T rowData) {
        var colValue = fetchValue(rowData, col.memberNames);
        if (colValue != null && col.viewMapper != null) {
            var mapper = (Column.Mapper<Object, String>) col.viewMapper;
            return mapper.map(colValue);
        }

        return colValue != null ? colValue.toString() : "";
    }

    void setValue(T rowData, String memberNames[], Object value) {
        Object acc = rowData;
        for (var i = 0; i < memberNames.length - 1; i++) {
            acc = JSExpression.of("acc[memberNames[i]]");
            acc = JSExpression.of("typeof acc === 'undefined' ? {} : acc");
        }

        JSExpression.of("acc[memberNames[memberNames.length - 1]] = value");
    }

    @async
    void persistNewRow(Row<T> row) {
        for (var generator : generated)
            setValue(row.data, generator.memberNames, generator.supplier.supply());
        row.data = onRowAdd.supply(row.data);
        var offset = (currentPage - 1) * currentSize;
        JSExpression.of("this._data.splice(offset, 0, row.data)");
    }

    private T[] _data;
    private Row<T>[] list;
    private boolean rerenderAll;
    private boolean filterEnabled = false;
    private String filterValue = "";

    int[] pageSizes = new int[]{10, 20, 50, 100};
    int currentPage = 1;
    int currentSize = pageSizes[0];
    int nPages;
    T[] filtered;
    HtmlElement theTable;
    Integer[] columnSizes;
    Void nop;
    Row<T> _selectedRow;

    void calcList() {
        var filterWords = arrayFilter(
            JSExpression.<String[]>of("this.filterValue.split(' ')"),
            s -> JSExpression.<Boolean>of("s.length != 0"));

        filtered = filterWords.length != 0 ?
            arrayFilter(_data, v -> {
                for (var col : columns) {
                    var strVal = colViewAsString(col, v);
                    for (var fVal : filterWords)
                        if (JSExpression.<Boolean>of("strVal.indexOf(fVal) != -1")) return true;
                }
                return false;
            }) : _data;

        nPages = JSExpression.of("Math.floor(this.filtered.length / this.currentSize)");
        if (filtered.length % currentSize != 0) nPages++;
        var offset = (currentPage - 1) * currentSize;
        var pageData = JSExpression.<T[]>of("this.filtered.slice(offset, offset + this.currentSize)");

        this.list = arrayMap(pageData, v -> new Row<>(v));

        if (this.list.length != 0) {
            this.list[0].selected = true;
            this._selectedRow = this.list[0];
        }
    }

    void disableFilterAndRerender() {
        this.filterValue = "";
        calcList();
        doRerender();
    }

    void switchPage(int diff) {
        currentPage += diff;
        if (currentPage < 1) currentPage = 1;
        if (currentPage > nPages) currentPage = nPages;
        calcList();
        doRerender(); // FIXME: move rerenderAll to calcPage
    }

    void doRerender() {
        this.columnSizes = arrayMap(columns, v -> 0);
        effect(rerenderAll);
    }

    void doRerenderAndKeepSize() {
        this.columnSizes = JSExpression.of("[].slice.call(this.theTable.tHead.rows[0].cells).map(e => e" +
            ".getBoundingClientRect().width)");
        effect(rerenderAll);
    }

    void initColumnsByDefault(T[] data) {
        var gridDataClass = ClassRef.of(data).params()[0];
        this.columns = arrayMap(gridDataClass.fields(), fieldRef -> {
            var col = new Column<T, Object>();
            col.applyDefaultSettings(new String[]{fieldRef.name()}, fieldRef.__class__().name());
            return col;
        });
    }


    @Override public div mount(T[] data) {
        this._data = data;
        if (columns.length == 0)
            initColumnsByDefault(data);

        this.columnSizes = arrayMap(columns, v -> 0);
        calcList();

        return new div() {{
            new div() {{
                dependsOn = rerenderAll;

                if (filtered.length > pageSizes[0])
                    new div() {{
                        style.display = "flex";
                        style.alignItems = "center";
                        style.backgroundColor = "#eee";
                        style.padding = "5px";
                        style.marginBottom = "15px";
                        new select() {{
                            onchange = ev -> {
                                currentSize = Integer.parseInt(ev.target.value);
                                currentPage = 1;
                                calcList();
                                doRerender();
                            };

                            for (var size : pageSizes)
                                new option("" + size) {{
                                    value = "" + size;
                                    selected = size == currentSize;
                                }};
                            style.marginRight = "10px";
                        }};
                        new span("записей на странице " + currentPage + " из " + nPages);
                        new div() {{
                            style.marginLeft = "auto";
                            new div() {{
                                innerHTML = """
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-left"><polyline points="15 18 9 12 15 6"/></svg>
                                    """;
                                className = "page-turn";
                                onclick = ev -> switchPage(-1);
                            }};
                            new div() {{
                                innerHTML = """
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"><polyline points="9 18 15 12 9 6"/></svg>
                                    """;
                                className = "page-turn";
                                onclick = ev -> switchPage(1);
                            }};
                        }};
                    }};
            }};

            if (filterEnabled)
                new div() {{
                    style.padding = "5px";
                    style.backgroundColor = "#eee";
                    style.marginBottom = "5px";
                    new input() {{
                        value = filterValue;
                        placeholder = "фильтр...";
                        style.width = "100%";
                        onkeyup = ev -> {
                            filterValue = ((input) ev.target).value;
                            calcList();
                            doRerender();
                        };
                    }};
                }};
            else new div(); // FIXME: rerender bug!!!;

            new table() {{
                theTable = this;
                dependsOn = rerenderAll;
                className = "table table-striped";
                style.margin = "0px 0px 0px 0px";
                new thead() {{
                    new tr() {{
                        for (var colWithSize : arrayZip(columns, columnSizes))
                            new td() {{
                                style.width = colWithSize.b + "px";
                                new span(colWithSize.a._header);
                            }};
                        new td() {{
                            style.width = "54px";
                            new div() {{
                                style.display = "flex";
                                style.justifyContent = "flex-end";
                                className = "toolbox-header";
                                new div() {{
                                    style.width = "16px";
                                    innerHTML = """                           
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-filter"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
                                        """;
                                    onclick = ev -> {
                                        if (filterEnabled) disableFilterAndRerender();
                                        effect(filterEnabled = !filterEnabled);
                                    };
                                }};
                                new div() {{
                                    style.width = "16px";
                                    innerHTML = """
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-plus"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                        """;
                                    onclick = ev -> {
                                        effect(filterEnabled = false);
                                        disableFilterAndRerender();
                                        var rowData = JSExpression.<T>of("{}"); // FIXME: use prototype.new
                                        for (var col : columns)
                                            setValue(rowData, col.memberNames, null);

                                        var newRow = new Row<>(rowData);
                                        newRow.editing = true;
                                        newRow.freshRow = true;
                                        JSExpression.of("this.list.splice(0, 0, newRow)");
                                        doRerenderAndKeepSize();
                                    };
                                }};
                            }};
                        }};
                    }};
                }};
                new tbody() {{
                    for (var row : list) {
                        new tr() {{
                            style.cursor = "pointer";
                            onclick = ev -> {
                                if (!row.editing) {
                                    for (var anotherRow : list) anotherRow.selected = false;
                                    _selectedRow = row;
                                    row.selected = !row.selected;
                                    doRerender();
                                }
                            };

                            if (row.freshRow && customRowAdder != null) {
                                for (var control : customRowAdder.controls)
                                    new td() {{
                                        colSpan = control._slots;
                                        new slot<>(control);
                                    }};
                            } else
                                for (var col : columns)
                                    new td() {{
                                        if (row.editing && col._editor != null) {
                                            nop = updateCol(col, row.data);
                                            new slot<>(col._editor);
                                        } else innerText = colViewAsString(col, row.data);
                                    }};

                            new td() {{
                                new div() {{
                                    style.display = "flex";
                                    className = "toolbox";
                                    if (!row.editing) {
                                        new div() {{
                                            innerHTML = """
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-minus"><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                                """;
                                            onclick = ev -> {
                                                ev.stopPropagation();
                                                _data = arrayFilter(_data, d -> !strictEqual(d, row.data));
                                                list = arrayFilter(list, r -> !strictEqual(row, r));
                                                onRowDelete.handle(row.data);
                                                doRerender();
                                            };
                                        }};
                                        new div() {{
                                            innerHTML = """
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                                                """;
                                            onclick = ev -> {
                                                ev.stopPropagation();
                                                row.editing = !row.editing;
                                                doRerenderAndKeepSize();
                                            };
                                        }};
                                        new div() {{
                                            innerHTML = row.expanded
                                                ? """
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-minimize-2"><polyline points="4 14 10 14 10 20"/><polyline points="20 10 14 10 14 4"/><line x1="14" y1="10" x2="21" y2="3"/><line x1="3" y1="21" x2="10" y2="14"/></svg>
                                                """
                                                : """
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-maximize-2"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg>
                                                """;
                                            onclick = ev -> {
                                                ev.stopPropagation();
                                                row.expanded = !row.expanded;
                                                doRerender();
                                            };
                                            title = "Иностранные переводы";
                                        }};
                                    } else {
                                        new div() {{
                                            innerHTML = """
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-save"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                                                """;
                                            onclick = ev -> {
                                                ev.stopPropagation();
                                                // save changes
                                                if (row.freshRow && customRowAdder != null)
                                                    row.data = customRowAdder.loader.load();

                                                else
                                                    for (var col : columns)
                                                        if (col._editor != null)
                                                            setValue(row.data, col.memberNames, col._editor.value);

                                                if (row.freshRow) { persistNewRow(row); row.freshRow = false; } else
                                                    onRowChange.handle(row.data);
                                                row.editing = !row.editing;
                                                doRerender();
                                            };
                                        }};
                                        new div() {{ // cancel save changes
                                            innerHTML = """
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                                                """;
                                            onclick = ev -> {
                                                ev.stopPropagation();
                                                row.editing = !row.editing;
                                                if (row.freshRow) // we added new row, but decided not save
                                                    JSExpression.of("this.list.splice(0, 1)"); // drop it
                                                doRerender();
                                            };
                                        }};
                                    }
                                }};
                            }};

                            if (row.editing)
                                style.backgroundColor = "#ffacac";
                            else if (selectedRow != null && (row.selected || row.expanded))
                                style.backgroundColor = "#acea9f";
                        }};

                        if (row.expanded) {
                            new tr(); // fake for stripe color save
                            new tr() {{
                                className = "expansion-row";
                                style.backgroundColor = "#acea9f";
                                //if (row.selected) style.backgroundColor = "#acea9f";
                                new td() {{
                                    colSpan = columns.length + 1;
                                    style.padding = "10px";
                                    style.borderBottom = "1px solid white";
                                    new div() {{
                                        style.backgroundColor = "white";
                                        style.display = "flex";
                                        style.justifyContent = "center";
                                        new div() {{
                                            style.width = "100%";
                                            new slot<>(expandedRow, row.data);
                                        }};
                                    }};
                                }};
                            }};
                        }
                    }
                }};
            }};

            new div() {{
                dependsOn = rerenderAll;
                style.backgroundColor = "white";
                style.display = "flex";
                style.padding = "15px";
                style.justifyContent = "center";
                if (_selectedRow != null && selectedRow != null) {
                    new div() {{
                        style.width = "100%";
                        new slot<>(selectedRow, _selectedRow.data);
                    }};
                }
            }};
        }};
    }
}